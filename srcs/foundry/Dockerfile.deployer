# Contract Deployer Dockerfile
FROM ghcr.io/foundry-rs/foundry:latest

# Set working directory
WORKDIR /app

# Copy foundry project
COPY . .

# Install dependencies (if using git submodules)
RUN forge install --no-commit || true

# Create deployment script directly in Dockerfile
RUN echo '#!/bin/bash\n\
set -e\n\
echo "🚀 Starting zkMed Contract Deployment..."\n\
\n\
# Wait for Anvil to be ready\n\
echo "⏳ Waiting for Anvil to be ready..."\n\
while ! nc -z ${RPC_HOST:-mantle-fork} 8545; do\n\
    echo "Waiting for Anvil..."\n\
    sleep 2\n\
done\n\
echo "✅ Anvil is ready!"\n\
\n\
# Build contracts\n\
echo "🔨 Building contracts..."\n\
forge build\n\
\n\
# Deploy Greeting contract\n\
echo "📝 Deploying Greeting contract..."\n\
GREETING_ADDRESS=$(forge create src/Greeting.sol:Greeting \\\n\
    --rpc-url ${RPC_URL:-http://mantle-fork:8545} \\\n\
    --private-key ${PRIVATE_KEY} \\\n\
    --constructor-args "Hello from zkMed!" | grep "Deployed to:" | cut -d " " -f 3)\n\
\n\
echo "✅ Greeting contract deployed at: $GREETING_ADDRESS"\n\
\n\
# Create addresses.json file\n\
echo "📄 Creating contract addresses file..."\n\
cat > out/addresses.json << EOF\n\
{\n\
    "chainId": ${CHAIN_ID:-31339},\n\
    "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",\n\
    "contracts": {\n\
        "Greeting": {\n\
            "address": "$GREETING_ADDRESS",\n\
            "deployer": "0xf39Fd6e51aad88F6F4ce6aB8827279cffFb92266"\n\
        }\n\
    },\n\
    "demoAccounts": {\n\
        "account1": {\n\
            "address": "0xf39Fd6e51aad88F6F4ce6aB8827279cffFb92266",\n\
            "privateKey": "0xac0974bec39a17e36ba4a6b4d238ff944bacb478cbed5efcae784d7bf4f2ff80",\n\
            "role": "Admin/Deployer"\n\
        },\n\
        "account2": {\n\
            "address": "0x70997970C51812dc3A010C7d01b50e0d17dc79C8",\n\
            "privateKey": "0x59c6995e998f97a5a0044966f0945389dc9e86dae88c7a8412f4603b6b78690d",\n\
            "role": "User"\n\
        },\n\
        "account3": {\n\
            "address": "0x3C44CdDdB6a900fa2b585dd299e03d12FA4293BC",\n\
            "privateKey": "0x5de4111afa1a4b94908f83103eb1f1706367c2e68ca870fc3fb9a804cdab365a",\n\
            "role": "User"\n\
        }\n\
    }\n\
}\n\
EOF\n\
\n\
echo "🎉 Deployment completed successfully!"\n\
echo "Contract Address: $GREETING_ADDRESS"\n\
echo "Chain ID: ${CHAIN_ID:-31339}"\n\
echo "RPC URL: ${RPC_URL:-http://mantle-fork:8545}"\n\
' > /app/deploy.sh && chmod +x /app/deploy.sh

# Create contract addresses output directory
RUN mkdir -p out

# Health check
HEALTHCHECK --interval=30s --timeout=10s --start-period=5s --retries=3 \
    CMD test -f /app/out/addresses.json || exit 1

# Default command
CMD ["/app/deploy.sh"] 